server {
	listen 80;
	server_name _;

	# Basic hardening
	server_tokens off;

	root /usr/share/nginx/html;
	index index.html;

	# Security headers (adjust CSP if you load external scripts/styles)
	add_header X-Frame-Options "SAMEORIGIN" always;
	add_header X-Content-Type-Options "nosniff" always;
	add_header Referrer-Policy "strict-origin-when-cross-origin" always;
	add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
	add_header Content-Security-Policy "default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; connect-src 'self' http: https:;" always;

	# Cache static assets aggressively
	# Don't cache the HTML entrypoint (so new deployments are picked up immediately)
	location = /index.html {
		expires -1;
		add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate" always;
		try_files $uri =404;
	}

	# Avoid caching common Angular entry bundles that might not be content-hashed in some builds
	location ~* ^/(?:main|polyfills|runtime|vendor)\.(?:js|mjs|map)$ {
		expires -1;
		add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate" always;
		try_files $uri =404;
	}

	# Cache fingerprinted/static assets aggressively
	location ~* \.(?:css|js|mjs|map|png|jpg|jpeg|gif|svg|ico|webp|woff|woff2|ttf|eot)$ {
		expires 1y;
		add_header Cache-Control "public, immutable";
		try_files $uri =404;
	}

	# Health endpoint for container checks
	location = /healthz {
		add_header Content-Type text/plain;
		return 200 "ok\n";
	}

	# Proxy calls to Java API (internal docker network)
	# Adjust the prefix if your frontend expects a different base path.
	location /api/ {
		proxy_pass http://java-api:8080/api/;
		proxy_http_version 1.1;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
	}

	# Proxy calls to FastAPI (internal docker network)
	# If your FastAPI isn't under /chat, change this route to match.
	location /chat/ {
		proxy_pass http://fastapi-chat:8010/;
		proxy_http_version 1.1;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
	}

	# FastAPI image analysis endpoint (used by Angular ChatService)
	location = /analyze_image {
		proxy_pass http://fastapi-chat:8010/analyze_image;
		proxy_http_version 1.1;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
	}

	# SPA fallback
	location / {
		try_files $uri $uri/ /index.html;
	}
}
